/*!
 * WP Media Picker -  version 0.5.0
 * 
 * Felix Arntz <felix-arntz@leaves-and-love.net>
 */
!function(a,b){if("undefined"==typeof b||"undefined"==typeof b.media)return a.fn.wpMediaPicker=function(){return this},void console.error("WP Media not found");var c=b.media.editor.send.attachment,d=window.send_to_editor,e=function(a){var b=window.wpActiveEditor;document.getElementById(b).innerHTML=a,window.send_to_editor=d};b.media.editor.send.attachment=function(d,f){var g;if(g=b.media.editor.activeEditor?b.media.editor.activeEditor:window.wpActiveEditor||"",0===g.search("wp-mediapicker-content-")){var h=g.substring("wp-mediapicker-content-".length);return window.send_to_editor=e,a("#"+h).wpMediaPicker("sendAttachment",f)}return c.apply(this,[d,f])};var f='<div class="wp-mediapicker-container" />',g='<a class="wp-mediapicker-open-button button" />',h='<a class="wp-mediapicker-remove-button" />',i='<div class="wp-mediapicker-content-wrap" />',j='<div class="wp-mediapicker-content" />',k={options:{store:"id",query:{},filterable:"all",searchable:!0,editable:!1,allowLocalEdits:!1,displaySettings:!1,displayUserSettings:!1,change:!1,clear:!1,label_add:b.media.view.l10n.addMedia,label_replace:b.media.view.l10n.replace,label_remove:b.media.view.l10n.remove,label_modal:b.media.view.l10n.addMedia,label_button:b.media.view.l10n.addMedia},_create:function(){var c=this;a.extend(c.options,c.element.data()),c.content_id="wp-mediapicker-content-"+c.element.attr("id"),c.element.hide().wrap(f),c.wrap=c.element.parent(),c.open_button=a(g).insertAfter(c.element),c.remove_button=a(h).insertAfter(c.open_button).text(c.options.label_remove),c.content_wrap=a(i).insertAfter(c.remove_button),c.content=a(j).appendTo(c.content_wrap).attr("id",c.content_id),c.workflow=b.media.editor.add(c.content_id,{frame:"select",state:"insert",states:[new b.media.controller.Library({id:"insert",title:c.options.label_modal,priority:20,toolbar:"select",filterable:c.options.filterable,library:b.media.query(c.options.query),multiple:!1,syncSelection:!0,editable:c.options.editable,allowLocalEdits:c.options.allowLocalEdits,displaySettings:c.options.displaySettings,displayUserSettings:c.options.displayUserSettings})],button:{event:"insert",text:c.options.label_button}}),c._updateContent(),c._addListeners()},_addListeners:function(){var a=this;a.open_button.on("click",function(b){b.preventDefault();var c=a.workflow.state("insert").get("selection");c.reset(a.attachment?[a.attachment]:[]),a.open()}),a.remove_button.on("click",function(b){b.preventDefault(),a.element.val(null),a._resetContent(),"function"==typeof a.options.clear&&a.options.clear.call(a)})},_createContent:function(a,b){var c=this;c.attachment=a,c.open_button.text(c.options.label_replace),c.remove_button.show();var d="";if("image"===a.type){var e=a.url;a.sizes&&a.sizes.large?e=a.sizes.large.url:a.sizes&&a.sizes.full&&(e=a.sizes.full.url),d+='<img src="'+e+'" alt="'+a.alt+'" />'}else if("video"===a.type){var f="";a.image&&a.image.src!==a.icon&&(f=a.image.src),d+='<video class="wp-video-shortcode" preload="metadata"'+(f?' poster="'+f+'"':"")+' controls><source type="'+a.mime+'" src="'+a.url+'" /></video>'}else"audio"===a.type?(d+=a.image&&a.image.src&&a.image.src!==a.icon?'<img class="wp-audio-cover" src="'+a.image.src+'" alt="'+a.filename+'" />':'<div class="mime-type-icon"><img src="'+a.icon+'" /><span>'+a.filename+"</span></div>",d+='<audio class="wp-audio-shortcode" width="100%" preload="none" controls><source type="'+a.mime+'" src="'+a.url+'" /></audio>'):d+='<div class="mime-type-icon"><img src="'+a.icon+'" /><span>'+a.filename+"</span></div>";return 0<=d.search("<img ")?c.content.addClass("size-auto"):c.content.removeClass("size-auto"),c.content.show(),b?d:void c.content.html(d)},_resetContent:function(){var a=this;a.attachment=null,a.open_button.text(a.options.label_add),a.remove_button.hide(),a.content.hide().empty().removeClass("size-auto")},_updateContent:function(){var a=this,c=a.element.val();c?"url"===a.options.store?b.media.ajax({type:"POST",data:{action:"get-attachment-by-url",url:c},success:function(b){a._createContent(b)},error:function(){a.element.val(null),a._resetContent()}}):b.media.ajax({type:"POST",data:{action:"get-attachment",id:parseInt(c,10)},success:function(b){a._createContent(b)},error:function(){a.element.val(null),a._resetContent()}}):(a.element.val(null),a._resetContent())},sendAttachment:function(a){var b=this;"url"===b.options.store?b.element.val(a.url):b.element.val(a.id);var c=b._createContent(a,!0);return"function"==typeof b.options.change&&b.options.change.call(b),c},open:function(){b.media.editor.open(this.content_id)},close:function(){this.workflow.close()},attachment:function(a){return"undefined"==typeof a?this.attachment:void(a?("url"===this.options.store?this.element.val(a.url):this.element.val(a.id),this._createContent(a)):(this.element.val(null),this._resetContent()))},value:function(a){return"undefined"==typeof a?this.attachment?"url"===this.options.store?this.attachment.url:this.attachment.id:"":(this.element.val(a),void this._updateContent())}};a.widget("wp.wpMediaPicker",k)}(jQuery,wp);